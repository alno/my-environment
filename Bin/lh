#!/usr/bin/env ruby

require 'rubygems'
require 'clamp'

LH_DIR = '/home/alno/Projects/LakeHouse'

class LakehouseCommand < Clamp::Command

  subcommand "up", "Update project(s)" do

    parameter "[PROJECT]", "project name"

    def update(dir)
      puts "Updating #{File.basename dir}"

      systen "cd #{dir} && svn up"
    end

    def execute
      if project
        update "#{LH_DIR}/#{project}"
      else
        Dir[LH_DIR + '/*'].each do |dir|
          next unless File.directory? dir
          next unless File.exists? "#{dir}/.svn"

          update dir
        end
      end
    end

  end

  subcommand "restart", "Restart server" do

    parameter "USER", "user name"
    parameter "DOMAIN", "domain name"

    def execute
      system "ssh #{user}@ontheline.ru \"cd www/#{domain} && svn up && touch tmp/restart.txt\""
    end

  end

  subcommand "deploy", "Deploy project to server" do

    parameter "USER", "user name"
    parameter "DOMAIN", "domain name"

    def execute
      puts `ssh #{user}@ontheline.ru "cd www/#{domain} && svn up && rake db:migrate RAILS_ENV=production && touch tmp/restart.txt"`
    end

  end

end

LakehouseCommand.run
